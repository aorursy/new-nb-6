#EEE-CIS –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞

# Reboot. DS -75. –ü–µ—Ä–≤—ã–π –ø–æ—Ç–æ–∫

# –í—ã–ø—É—Å–∫–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –î–µ–º–∏–Ω–∞ –ê.–í
# –ó–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏:  https://www.kaggle.com/c/ieee-fraud-detection/overview

# –ó–∞ –æ—Å–Ω–æ–≤—É –≤–∑—è—Ç—ã –Ω–æ—Ç–µ–±—É–∫–∏: 

#                                    https://www.kaggle.com/artgor/eda-and-models 

#                                    https://www.kaggle.com/jesucristo/fraud-complete-eda

#                                    https://www.kaggle.com/cybercat/naive-modeling-using-minimum-analysis  

#                                    https://www.kaggle.com/dejavu23/titanic-survival-seaborn-and-ensembles
# –õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± —É—á–∞—Å—Ç–∏—è –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏ ‚Äî –Ω–∞–π—Ç–∏ —á—É–∂–æ–µ —è–¥—Ä–æ —Å —Ö–æ—Ä–æ—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤, —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. 

# (c) https://tproger.ru/translations/kaggle-competitions-introduction/
# –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Ü–µ–Ω–∏–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é ROC AUC –º–µ–∂–¥—É –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ–π —Ü–µ–ª—å—é.



# –•–æ—Ç—è –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞–¥–∞—á–∏ –±–∏–Ω–∞—Ä–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, 

# —ç—Ç–æ –±—É–¥–µ—Ç –ø–ª–æ—Ö–∏–º —Ä–µ—à–µ–Ω–∏–µ–º, –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –∏–º–µ–µ–º –¥–µ–ª–æ —Å –ø—Ä–æ–±–ª–µ–º–æ–π –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞. 

# –í–º–µ—Å—Ç–æ —Ç–æ—á–Ω–æ—Å—Ç–∏, —Ä–µ—à–µ–Ω–∏—è –æ—Ü–µ–Ω–∏–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é ROC AUC (Receiver Operating Characteristic curve Area Under the Curve). 

# –ß–µ–º –≤—ã—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Ç–µ–º –ª—É—á—à–µ. –ß—Ç–æ–±—ã –≤–µ—Å—Ç–∏ –ø–æ–¥—Å—á—ë—Ç—ã —Å –ø–æ–º–æ—â—å—é ROC AUC, –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π, –∞ –Ω–µ –±–∏–Ω–∞—Ä–Ω—ã–µ ‚Äî 0 –∏–ª–∏ 1. 

# ROC –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–∏–Ω–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ª–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π, –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Ä–æ–≥–∞, —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π.



# –û–±—ã—á–Ω–æ –Ω—Ä–∞–≤–∏—Ç—Å—è –¥–µ–ª–∞—Ç—å –Ω–∞–∏–≤–Ω–æ–µ –±–∞–∑–æ–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ, –Ω–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã —É–∂–µ –∑–Ω–∞–µ–º, —á—Ç–æ —Å–ª—É—á–∞–π–Ω—ã–µ –¥–æ–≥–∞–¥–∫–∏ –ø–æ –∑–∞–¥–∞—á–µ –±—É–¥—É—Ç —Ä–∞–≤–Ω—ã 0,5 –ø–æ ROC AUC. 
# –§–∞–π–ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ TransactionID –≤ –Ω–∞–±–æ—Ä–µ —Ç–µ—Å—Ç–æ–≤ –≤—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π isFraud. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∏–º–µ—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç:

# TransactionID,isFraud

# 3663549,0.5

# 3663550,0.5

# 3663551,0.5

# –∏ —Ç.–¥.



# Categorical Features - Transaction 

# –§—É–Ω–∫—Ü–∏—è TransactionDT –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–µ–ª—å—Ç—É –∏–∑ –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞)
# –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–æ–ø–∏—Å–∞–Ω–∏–µ https://www.kaggle.com/c/ieee-fraud-detection/discussion/101203)

# TransactionDT: timedelta –∏–∑ –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞)

# TransactionAMT: —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê

# ProductCD: –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞, —Ç–æ–≤–∞—Ä –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

# card1 - card6: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–Ω–æ–π –∫–∞—Ä—Ç–µ, —Ç–∞–∫–∞—è –∫–∞–∫ —Ç–∏–ø –∫–∞—Ä—Ç—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–∞—Ä—Ç—ã, –±–∞–Ω–∫-—ç–º–∏—Ç–µ–Ω—Ç, —Å—Ç—Ä–∞–Ω–∞ –∏ —Ç. –¥.

# addr: –∞–¥—Ä–µ—Å

# dist: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ

# P_ –∏ (R__) emaildomain: –¥–æ–º–µ–Ω —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è

# C1-C14: –ø–æ–¥—Å—á–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π –∫–∞—Ä—Ç–æ–π, –∏ —Ç. –î. –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è.

# D1-D15: –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–Ω–∏ –º–µ–∂–¥—É –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ —Ç. –î.

# M1-M9: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä –∏–º–µ–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –∞–¥—Ä–µ—Å –∏ —Ç. –î.

# Vxxx: Vesta —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∞ –±–æ–≥–∞—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥—Å—á–µ—Ç –∏ –¥—Ä—É–≥–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π.



# –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:

# ProductCD

# card1 - card6

# addr1, addr2

# P emaildomain R emaildomain

# M1 - M9



# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ *

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ç–µ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (IP, ISP, Proxy –∏ —Ç. –î.) –ò —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å (UA / browser / os / version –∏ —Ç. –î.), –°–≤—è–∑–∞–Ω–Ω—É—é —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.

# –û–Ω–∏ —Å–æ–±—Ä–∞–Ω—ã —Å–∏—Å—Ç–µ–º–æ–π –∑–∞—â–∏—Ç—ã –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ Vesta –∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏ –ø–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

# (–ò–º–µ–Ω–∞ –ø–æ–ª–µ–π –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø–∞—Ä–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –Ω–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞)



# –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:

# DeviceType

# DeviceInfo

# ID 12 - ID 38
# –§–∞–π–ª—ã

# train_{transaction, identity}.csv - the training set

# test_{transaction, identity}.csv - the test set (you must predict the isFraud value for these observations)

# sample_submission.csv - a sample submission file in the correct format
# –∑–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫

import pandas as pd

import numpy as np

import warnings

#warnings.filterwarnings("ignore", category=DeprecationWarning)

#warnings.filterwarnings("ignore", category=FutureWarning)

warnings.filterwarnings("ignore")

import matplotlib.pyplot as plt




from tqdm import tqdm_notebook



from sklearn.model_selection import train_test_split

from sklearn.preprocessing import StandardScaler

from sklearn.svm import NuSVR, SVR

from sklearn.metrics import mean_absolute_error

from sklearn import preprocessing



from sklearn.decomposition import PCA

from sklearn.preprocessing import StandardScaler



from sklearn.model_selection import KFold, StratifiedKFold

from sklearn.metrics import roc_auc_score



import xgboost as xgb

import lightgbm as lgb

import catboost



import time



pd.options.display.precision = 15

import seaborn as sns


sns.set()



# plotly library

import plotly.graph_objs as go

from plotly import tools

from plotly.offline import init_notebook_mode, iplot

init_notebook_mode(connected=True)

import gc
# –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—Ö–æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ https://www.kaggle.com/c/ieee-fraud-detection/data

from subprocess import check_output

folder_path = "../input/ieee-fraud-detection/"

print(check_output(["ls", folder_path]).decode("utf8"))
# –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤

train_identity = pd.read_csv(f'{folder_path}train_identity.csv')

train_transaction = pd.read_csv(f'{folder_path}train_transaction.csv')

test_identity = pd.read_csv(f'{folder_path}test_identity.csv')

test_transaction = pd.read_csv(f'{folder_path}test_transaction.csv')

sub = pd.read_csv(f'{folder_path}sample_submission.csv')   
# –ù–∞–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ train_identity



# TransactionID,

# id_01,id_02,id_03,id_04,id_05,id_06,id_07,id_08,id_09,id_10,id_11,id_12,id_13,id_14,id_15,id_16,id_17,id_18,id_19,id_20,id_21,id_22,id_23,id_24,id_25,id_26,id_27,id_28,id_29,id_30,id_31,id_32,id_33,id_34,id_35,id_36,id_37,id_38,

# DeviceType,DeviceInfo



# –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: 2987004,0.0,70787.0,,,,,,,,,100.0,NotFound,,-480.0,New,NotFound,166.0,,542.0,144.0,,,,,,,,New,NotFound,Android 7.0,samsung browser 6.2,32.0,2220x1080,match_status:2,T,F,T,T,mobile,SAMSUNG SM-G892A Build/NRD90M



# –ù–∞–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ train_transaction



# TransactionID,isFraud,TransactionDT,TransactionAmt,ProductCD,card1,card2,card3,card4,card5,card6,addr1,addr2,dist1,dist2,P_emaildomain,R_emaildomain,



# C1,C2,C3,C4,C5,C6,C7,C8,C9,C10,C11,C12,C13,C14,

# D1,D2,D3,D4,D5,D6,D7,D8,D9,D10,D11,D12,D13,D14,D15,

# M1,M2,M3,M4,M5,M6,M7,M8,M9,

# V1,V2,V3,V4,V5,V6,V7,V8,V9,V10,V11,V12,V13,V14,V15,V16,V17,V18,V19,V20,V21,V22,V23,V24,V25,V26,V27,V28,V29,V30,V31,V32,V33,V34,V35,V36,V37,V38,V39,V40,V41,V42,V43,V44,V45,V46,V47,V48,V49,V50,

# V51,V52,V53,V54,V55,V56,V57,V58,V59,V60,V61,V62,V63,V64,V65,V66,V67,V68,V69,V70,V71,V72,V73,V74,V75,V76,V77,V78,V79,V80,V81,V82,V83,V84,V85,V86,V87,V88,V89,V90,V91,V92,V93,V94,V95,V96,V97,V98,V99,V100,

# V101,V102,V103,V104,V105,V106,V107,V108,V109,V110,V111,V112,V113,V114,V115,V116,V117,V118,V119,V120,V121,V122,V123,V124,V125,V126,V127,V128,V129,V130,V131,V132,V133,V134,V135,V136,V137,V138,V139,V140,

# V141,V142,V143,V144,V145,V146,V147,V148,V149,V150,V151,V152,V153,V154,V155,V156,V157,V158,V159,V160,V161,V162,V163,V164,V165,V166,V167,V168,V169,V170,V171,V172,V173,V174,V175,V176,V177,V178,V179,V180,

# V181,V182,V183,V184,V185,V186,V187,V188,V189,V190,V191,V192,V193,V194,V195,V196,V197,V198,V199,V200,V201,V202,V203,V204,V205,V206,V207,V208,V209,V210,V211,V212,V213,V214,V215,V216,V217,V218,V219,V220,

# V221,V222,V223,V224,V225,V226,V227,V228,V229,V230,V231,V232,V233,V234,V235,V236,V237,V238,V239,V240,V241,V242,V243,V244,V245,V246,V247,V248,V249,V250,V251,V252,V253,V254,V255,V256,V257,V258,V259,V260,

# V261,V262,V263,V264,V265,V266,V267,V268,V269,V270,V271,V272,V273,V274,V275,V276,V277,V278,V279,V280,V281,V282,V283,V284,V285,V286,V287,V288,V289,V290,V291,V292,V293,V294,V295,V296,V297,V298,V299,V300,

# V301,V302,V303,V304,V305,V306,V307,V308,V309,V310,V311,V312,V313,V314,V315,V316,V317,V318,V319,V320,V321,V322,V323,V324,V325,V326,V327,V328,V329,V330,V331,V332,V333,V334,V335,V336,V337,V338,V339

# –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞:2987000,0,86400,68.5,W,13926,,150.0,discover,142.0,credit,315.0,87.0,19.0,,,,1.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,2.0,0.0,1.0,1.0,14.0,,13.0,,,,,,,13.0,13.0,,,,0.0,T,T,T,M2,F,T,,,,

# 1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.0,0.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,1.0,1.0,0.0,0.0,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,,,,,,,,,,,,,,,,,,,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,1.0,1.0,0.0,

# 0.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,

# 1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.0,117.0,0.0,0.0,0.0,0.0,0.0,117.0,0.0,0.0,0.0,0.0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,

# 0.0,0.0,0.0,1.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,1.0,1.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,117.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,117.0,0.0,0.0,0.0,0.0,,,,,,,,,,,,,,,,,,

print(train_transaction.head(1))
print(train_identity.head(1))
# –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ merge(), –∫–æ—Ç–æ—Ä–∞—è —Å–æ–µ–¥–∏–Ω—è–µ—Ç –¥–≤–∞ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–∞–Ω–∞–ª–æ–≥ join –≤ SQL)

train = pd.merge(train_transaction, train_identity, on='TransactionID', how='left')

test = pd.merge(test_transaction, test_identity, on='TransactionID', how='left')

print(f'–î–∞—Ç–∞—Å–µ—Ç Train —Å–æ–¥–µ—Ä–∂–∏—Ç {train.shape[0]} —Å—Ç—Ä–æ–∫ and {train.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤')

print(f'–î–∞—Ç–∞—Å–µ—Ç Test —Å–æ–¥–µ—Ä–∂–∏—Ç {test.shape[0]} —Å—Ç—Ä–æ–∫ and {test.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤')
# –ò—Ç–∞–∫, —É –Ω–∞—Å –µ—Å—Ç—å –¥–≤–∞ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤. Train –∏ test –∏–º–µ—é—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
# –ü–æ—Å–∫–æ–ª—å–∫—É –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, —Ç–æ —É–¥–∞–ª–∏–º –∏–∑ –ø–∞–º—è—Ç–∏ –ø–µ—Ä–≤–∏—á–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã:

del train_identity, train_transaction, test_identity, test_transaction
# –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–µ–º —Å–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—á–∏—Å—Ç–∏—Ç –ø–∞–º—è—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ 3 –≥–±):

gc.collect()
# ‚úî –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
print(train.head(5))
print (train.info())
print(test.head(5))
print (test.info())
print(f'–ò–∑ –≤—Å–µ—Ö {train.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–∞—Ç–∞—Å–µ—Ç–∞ Train {train.isnull().any().sum()} —Å—Ç–æ–ª–±—Ü–æ–≤ —Å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∏–º –ø—É—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º')
#–ü–æ–¥—Å—á–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Ç–æ–ª–±—Ü—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è NaN, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Ö —É—á–∏—Ç—ã–≤–∞—Ç—å, —Ç–æ nunique( self , axis = 0 , dropna = False)

one_value_cols = [col for col in train.columns if train[col].nunique() <= 1] 

one_value_cols_test = [col for col in test.columns if test[col].nunique() <= 1]    

one_value_cols == one_value_cols_test
print(f'–í—Å–µ–≥–æ {len(one_value_cols)} —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ train —Å –æ–¥–Ω–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.')

print(f'–í—Å–µ–≥–æ {len(one_value_cols_test)} —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ test —Å –æ–¥–Ω–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º')
missing_values_count = train.isnull().sum()

print (missing_values_count[0:10])

total_cells = np.product(train.shape)

total_missing = missing_values_count.sum()

print ("% –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö = ",(total_missing/total_cells) * 100)
del missing_values_count, total_cells, total_missing, one_value_cols, one_value_cols_test

gc.collect()
# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã:

#   –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ 

#   –¢–∞–∫–∂–µ –µ—Å—Ç—å —Å—Ç–æ–ª–±—Ü—ã —Å –æ–¥–Ω–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–∏–ª–∏ –≤—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç). 

#   –ï—Å—Ç—å –º–Ω–æ–≥–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ. 
# –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –∏ —á–∏—Å–ª–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤

# –°–ø—Ä–∞–≤–æ—á–Ω–æ —Ç–∏–ø—ã –≤ pandas: https://pbpython.com/pandas_dtypes.html

numerical_feats = train.dtypes[ (train.dtypes != "object") & (train.dtypes != "category") ].index

numerical_feats_kol = len(numerical_feats)

print("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∏—á–µ–π –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ train: ", numerical_feats_kol)



categorical_feats = train.dtypes[ (train.dtypes == "object") | (train.dtypes == "category") ].index

categorical_feats_kol = len(categorical_feats)

print("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∏—á–µ–π –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ train: ", categorical_feats_kol)
# —É—Å—Ç–∞–Ω–æ–≤–∏–º —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ–±—ã –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∏—á (–±–µ–∑ ..)

# –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.set_option.html

#pd.set_option('display.max_rows', 1000)

#pd.set_option('display.max_columns', 1000)



pd.set_option('display.width', 200)  # —à–∏—Ä–∏–Ω–∞ –≤—ã–≤–æ–¥–∏–º–æ–≥–æ —ç–∫—Ä–∞–Ω–∞

pd.set_option('max_seq_items', 500)  # —Ç–æ –∏–∑-—á–µ–≥–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∏ —Å—Ç–∞–≤–∏—Ç—å ..



print("–ò–º–µ–Ω–∞ —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∏—á–µ–π –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ train:")

print(train[numerical_feats].columns)

print("*"*100)

print("–ò–º–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ train:")

print(train[categorical_feats].columns)
#–¥–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∏—á–µ–π —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º describe(), —Ñ–∏—á–µ–π –º–Ω–æ–≥–æ, –ø–æ—ç—Ç–æ–º—É —Å–¥–µ–ª–∞–µ–º —Ä–∞–∑–±–∏–≤–∫—É:

gr_kol = 50 # –∫–æ–ª-–≤–æ —Ñ–∏—á–µ–π –∑–∞ 1 –ø—Ä–æ—Ö–æ–¥

n1 = 0

for i in tqdm_notebook(range (1,numerical_feats_kol // gr_kol + 2)):

    n2 = i * gr_kol 

    if n2 > (numerical_feats_kol - 1):

        n2 =  numerical_feats_kol - 1

    cols = [numerical_feats[j] for j in range (n1,n2+1) ]

    #print (cols)

    

    plot_data = pd.DataFrame(train[cols])



    if 0: # –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è

        max_rows =1000    

        plot_data = pd.DataFrame(plot_data[:max_rows])

    

    print(plot_data.describe())   

    n1 = n2 +1
#–¥–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∏—á–µ–π –ø–æ—Å—Ç—Ä–æ–∏–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã. –§–∏—á–µ–π –º–Ω–æ–≥–æ, –Ω–æ –ø—Ä–∏ —Ä–∞–∑–±–∏–≤–∫–µ —Å–¥–µ–ª–∞–Ω–Ω–æ–π –≤—ã—à–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–∏–≤—ã—é—Ç, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–±–∏–≤–∞—Ç—å –Ω–µ –±—É–¥–µ–º (–ø—Ä–æ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ–ª–≥–æ)

plot_data = pd.DataFrame(train[numerical_feats])

if 0: # –¥–ª—è —Ç–µ—Å—Ç—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è

    max_rows =1000    

    plot_data = pd.DataFrame(plot_data[:max_rows])



_ = plot_data.hist(plot_data.columns, figsize=(60, 40))
# –ê–Ω–∞–ª–∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∏—á–µ–π
fig, ax = plt.subplots(1, 2, figsize=(18,4))



time_val = train['TransactionDT'].values



sns.distplot(time_val, ax=ax[0], color='r')

ax[0].set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TransactionDT', fontsize=14)

ax[1].set_xlim([min(time_val), max(time_val)])



sns.distplot(np.log(time_val), ax=ax[1], color='b')

ax[1].set_title('–†–∞—Å–ø–µ—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∞—Ä–∏—Ñ–º–∞ TransactionDT', fontsize=14)

ax[1].set_xlim([min(np.log(time_val)), max(np.log(time_val))])



plt.show()
fig, ax = plt.subplots(1, 2, figsize=(18,4))



time_val = train.loc[train['isFraud'] == 1]['TransactionDT'].values



sns.distplot(np.log(time_val), ax=ax[0], color='r')

ax[0].set_title('–†–∞—Å–ø–µ—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∞—Ä–∏—Ñ–º–∞ TransactionDT, isFraud=1', fontsize=14)

ax[1].set_xlim([min(np.log(time_val)), max(np.log(time_val))])



time_val = train.loc[train['isFraud'] == 0]['TransactionDT'].values



sns.distplot(np.log(time_val), ax=ax[1], color='b')

ax[1].set_title('–†–∞—Å–ø–µ—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∞—Ä–∏—Ñ–º–∞ TransactionDT, isFraud=0', fontsize=14)

ax[1].set_xlim([min(np.log(time_val)), max(np.log(time_val))])





plt.show()
train['TransactionDT'].plot(kind='hist',

                                        figsize=(15, 5),

                                        label='train',

                                        bins=50,

                                        title='Train –ø—Ä–æ—Ç–∏–≤ Test TransactionDT —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è')

test['TransactionDT'].plot(kind='hist',

                                       label='test',

                                       bins=50)

plt.legend()

plt.show()
plt.figure(figsize=(30, 10))

c_features = [col for col in train[numerical_feats].columns if (col[:1] == "c") | (col[:1] == "C")] 

uniques = [len(train[col].unique()) for col in c_features]

sns.set(font_scale=1.2)

ax = sns.barplot(c_features, uniques, log=True)

ax.set(xlabel='–ü—Ä–∏–∑–Ω–∞–∫–∏', ylabel='–ª–æ–≥–∞—Ä–∏—Ñ–º(–∫–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö)', title='–ß–∏—Å–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏—á–µ–π TRAIN')

for p, uniq in zip(ax.patches, uniques):

    height = p.get_height()

    ax.text(p.get_x()+p.get_width()/2.,

            height + 10,

            uniq,

            ha="center") 
print(train['id_01'].unique())

print(len(train['id_01'].unique())-1)
plt.hist(train['id_01'], bins=77); #bins - –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –±–∏–Ω—ã + 1 —Ä–µ–±—Ä–æ –±–∏–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å numpy.histogram

plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–∞ id_01');
# id_01 –∏–º–µ–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: —É –Ω–µ–≥–æ 77 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–µ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
# –ü–æ—Å–º–æ—Ç—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏–∑–Ω–∫–∞ id_03

# –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è, —Ç–∞–∫ —á—Ç–æ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–º—Å—è —ç–ª–µ–º–µ–Ω—Ç–æ–º. –ò—Å–∫–ª—é—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è NA –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

# normalize: –ª–æ–≥–∏—á–µ—Å–∫–∏–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False, –ï—Å–ª–∏ True, —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

train['id_03'].value_counts(dropna=False, normalize=True).head()
# d_03 —Å–æ–¥–µ—Ä–∂–∏—Ç 88% –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –∞ 98% –∑–Ω–∞—á–µ–Ω–∏–π –ª–∏–±–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –ª–∏–±–æ —Ä–∞–≤–Ω—ã 0.
train['id_11'].value_counts(dropna=False, normalize=True).head()
# 22% –∑–Ω–∞—á–µ–Ω–∏–π –≤ id_11 —Ä–∞–≤–Ω—ã 100, –∞ 76% –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. 
plt.hist(train['id_07']);

plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–∞ id_07');

# –∑–∞ –æ—Å–Ω–æ–≤—É –≤–∑—è—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ –Ω–æ—É—Ç–±—É–∫–∞ https://www.kaggle.com/jesucristo/fraud-complete-eda

# –∫–æ—Ç–æ—Ä—ã–π –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ—É—Ç–±—É–∫ https://www.kaggle.com/gemartin/load-data-reduce-memory-usage

# –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï! –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

def reduce_mem_usage2(df):

    # –ø–µ—Ä–µ–±–µ—Ä–∏—Ç–µ –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∫–∞–¥—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏.      

    start_mem = df.memory_usage().sum() / 1024**2

    print('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {:.2f} MB'.format(start_mem))

    

    for col in tqdm_notebook(df.columns):

        col_type = df[col].dtype

        

        if col_type != object:

            c_min = df[col].min()

            c_max = df[col].max()

            if str(col_type)[:3] == 'int':

                if c_min > np.iinfo(np.int8).min and c_max < np.iinfo(np.int8).max:

                    df[col] = df[col].astype(np.int8)

                elif c_min > np.iinfo(np.int16).min and c_max < np.iinfo(np.int16).max:

                    df[col] = df[col].astype(np.int16)

                elif c_min > np.iinfo(np.int32).min and c_max < np.iinfo(np.int32).max:

                    df[col] = df[col].astype(np.int32)

                elif c_min > np.iinfo(np.int64).min and c_max < np.iinfo(np.int64).max:

                    df[col] = df[col].astype(np.int64)  

            else:

                if c_min > np.finfo(np.float16).min and c_max < np.finfo(np.float16).max:

                    df[col] = df[col].astype(np.float16)

                elif c_min > np.finfo(np.float32).min and c_max < np.finfo(np.float32).max:

                    df[col] = df[col].astype(np.float32)

                else:

                    df[col] = df[col].astype(np.float64)

        else:

            df[col] = df[col].astype('category')



    end_mem = df.memory_usage().sum() / 1024**2

    print('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç: {:.2f} MB'.format(end_mem))

    print('–≠–∫–æ–Ω–æ–º–∏—è —Å–æ—Å—Ç–∞–≤–∏–ª–∞ {:.1f}%'.format(100 * (start_mem - end_mem) / start_mem))

    

    return df
# –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –æ–±–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ train –∏ test –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø—è–º—è—Ç–∏ –∏ —Å–æ–∑–¥–∞–¥–∏–º –æ–¥–∏–Ω –æ–±—ä–µ–¥–µ–Ω–µ–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ–∏—á–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
# –î–ª—è —á–∏—Å—Ç–æ—Ç—ã —É–¥–∞–ª–∏–º —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –∏ –∑–∞–≥—Ä—É–∑–∏–º –∏–∑ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

del train, test

gc.collect()
# –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤



train_identity = pd.read_csv(f'{folder_path}train_identity.csv')

train_transaction = pd.read_csv(f'{folder_path}train_transaction.csv')

test_identity = pd.read_csv(f'{folder_path}test_identity.csv')

test_transaction = pd.read_csv(f'{folder_path}test_transaction.csv')

  

# –∫–ª–µ—Ç–æ—á–Ω–∞—è –º–∞–≥–∏—è %% –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é. –í–æ—Ç –ø–æ—á–µ–º—É –æ–Ω–∞ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–ª–µ—Ç–æ—á–Ω–æ–π –º–∞–≥–∏–µ–π üòä

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–Ω–∫—Ç–æ–≤ –Ω–∏–∂–µ –∑–∞–π–º–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

gc.collect()

train_tr = reduce_mem_usage2(train_transaction)

train_id = reduce_mem_usage2(train_identity)

gc.collect()

test_tr = reduce_mem_usage2(test_transaction)

test_id = reduce_mem_usage2(test_identity)
del train_identity,train_transaction, test_identity, test_transaction

gc.collect()
# —Å–æ–∑–¥–∞–¥–∏–º —Ç—Ä–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞: train, test –∏ –∏—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ dataset

train = pd.merge(train_tr, train_id, on='TransactionID', how='left')

test = pd.merge(test_tr, test_id, on='TransactionID', how='left')

dataset = pd.concat([train, test], axis=0, sort=False).reset_index(drop=True)

train_len = len(train)
del train_tr, train_id, test_tr, test_id

gc.collect()
# –ß–∏—Å–ª–æ–≤—ã–µ —Ñ–∏—á–∏

num_cols = [col for col in dataset.columns if dataset[col].dtype in ['int8', 'int16', 'int32', 'int64', 'float16', 'float32', 'float64']]

dataset[num_cols].describe()
#–ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∏

cat_cols = [col for col in dataset.columns if dataset[col].dtype not in ['int8', 'int16', 'int32', 'int64', 'float16', 'float32', 'float64']]

dataset[cat_cols].describe()
# –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–º —Ñ–∏—á–∞–º —Å–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ—Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ isFraud 

for col in cat_cols:

    print('-'*25+'['+col+']'+'-'*25)

    print(dataset[[col, 'isFraud']].groupby(col).mean()*100)
# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ–∏—á–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
# –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º TransactionDT –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –¥–∞—Ç—É –∏ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é —Ñ–∏—á—É Date

import datetime



genesis = datetime.datetime.strptime('2019-01-01', '%Y-%m-%d')

dataset['Date'] = dataset['TransactionDT'].apply(lambda x : genesis+datetime.timedelta(seconds=x))
# —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–µ —Ñ–∏—á–∏:

dataset['Weekdays'] = dataset['Date'].dt.dayofweek

dataset['Days'] = dataset['Date'].dt.day

dataset['Hours'] = dataset['Date'].dt.hour
fig, ax = plt.subplots(1, 3, figsize=(15, 5))



g = sns.barplot(dataset[dataset.index<train_len].Weekdays, train.isFraud, ax=ax[0])

ax[0].set_title('Fraud Charges by Weekdays')

plt.setp(g.get_xticklabels(), visible=False)



g = sns.barplot(dataset[dataset.index<train_len].Days, train.isFraud, ax=ax[1])

ax[1].set_title('Fraud Charges by Days')

plt.setp(g.get_xticklabels(), visible=False)



g = sns.barplot(dataset[dataset.index<train_len].Hours, train.isFraud, ax=ax[2])

ax[2].set_title('Fraud Charges by Hours')

plt.setp(g.get_xticklabels(), visible=False)



plt.show()
# –º–æ–∂–Ω–æ —É–≤–∏–¥–∏–¥–µ—Ç—å —è–≤–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —á–∞—Å–æ–≤ –∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
dataset.drop('Date', axis=1, inplace=True)
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∫–∏—Ö –∏–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ø–æ—á—Ç–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤
print(dataset['P_emaildomain'].value_counts().head())

print('Data type : {}'.format(dataset['P_emaildomain'].dtype))
# –æ–±—ä–µ–¥–µ–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—á—Ç–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –≤ –∑–Ω–∞—á–µ–Ω–∏–µ –¥—Ä—É–≥–∏–µ (etc)

dataset.loc[(dataset.P_emaildomain!='gmail.com')&(dataset.P_emaildomain!='yahoo.com')&(dataset.P_emaildomain!='hotmail.com')&(dataset.P_emaildomain!='anonymous.com')&(dataset.P_emaildomain!='aol.com'), 'P_emaildomain'] = 'etc'
sns.countplot(dataset['P_emaildomain'])

fig = plt.gcf()

fig.set_size_inches(10, 4)

plt.show()
print(dataset['R_emaildomain'].value_counts().head())

print('Data type : {}'.format(dataset['P_emaildomain'].dtype))
sns.countplot(dataset['R_emaildomain'])

fig = plt.gcf()

fig.set_size_inches(10, 4)

plt.show()
# –ê–Ω–∞–ª–∏–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–æ–∫
top_os = dataset[['id_30', 'isFraud']].groupby(['id_30']).mean().sort_values(by=['isFraud'], ascending=False).head(10)

top_os.T
# –í—ã–≤–æ–¥: –æ–±–≤–∏–Ω–µ–Ω–∏—è –≤ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –º–æ–±–∏–ª—å–Ω—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ–¥–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (–æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏–º–∏)
top_os = list(top_os.index)
all_os = list(dataset['id_30'].unique())

safe_os = [os for os in all_os if os not in top_os]
dataset.id_30.replace(safe_os, 'etc', inplace=True)
dataset[['id_30', 'isFraud']].groupby(['id_30']).mean().T
# –ê–Ω–∞–ª–∏–∑ –±—Ä–∞—É–∑–µ—Ä–æ–≤
top_browsers = dataset[['id_31', 'isFraud']].groupby(['id_31']).mean().sort_values(by=['isFraud'], ascending=False).head(10)

top_browsers.T
top_browsers = list(top_browsers.index)
all_browsers = list(dataset['id_31'].unique())

safe_browsers = [brw for brw in all_browsers if brw not in top_browsers]
dataset.id_31.replace(safe_browsers, 'etc', inplace=True)
dataset[['id_31', 'isFraud']].groupby('id_31').mean().sort_values(by='isFraud', ascending=False).T
# –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞

# —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
top_scrsz = dataset[['id_33', 'isFraud']].groupby(['id_33']).mean().sort_values(by=['isFraud'], ascending=False).head(15)

top_scrsz.T
top_scrsz = list(top_scrsz.index)
all_scrsz = dataset['id_33'].unique()

safe_scrsz = [s for s in all_scrsz if s not in top_scrsz]
dataset.id_33.replace(safe_scrsz, 'etc', inplace=True)
dataset[['id_33', 'isFraud']].groupby('id_33').mean().sort_values(by='isFraud', ascending=False).T
# –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
top_dev = dataset[['DeviceInfo', 'isFraud']].groupby(['DeviceInfo']).mean().sort_values(by='isFraud', ascending=False).head(10)

top_dev.T
top_dev = list(top_dev.loc[top_dev.isFraud>0.5].index)

top_dev
all_dev = dataset['DeviceInfo'].unique()

safe_dev = [dev for dev in all_dev if dev not in top_dev]
dataset.DeviceInfo.replace(safe_dev, 'etc', inplace=True)
dataset[['DeviceInfo', 'isFraud']].groupby('DeviceInfo').mean().sort_values(by=['isFraud'], ascending=False).T
# –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: one-hot

dataset_num = dataset.select_dtypes(exclude=['object'])

dataset_num.head()
dataset_cat = dataset.select_dtypes(include=['object'])

dataset_cat.head()
print('Added Columns : {}'.format(sum(dataset_cat.nunique().values)-len(dataset_cat.columns)))
dataset_cat_new = pd.get_dummies(dataset_cat) #–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏

dataset = pd.concat([dataset_num, dataset_cat_new], axis=1) #—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç

dataset.shape
dataset.drop('TransactionID', axis=1, inplace=True) # —É–¥–∞–ª–∏–º TransactionID

del dataset_num, dataset_cat

gc.collect()
# –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
dataset.head()
# –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º train –∏ test

train = dataset[:train_len]

test = dataset[train_len:]
# —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç–∞—Å–µ—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è

y = train.isFraud

X = train.drop('isFraud', axis=1)

test_y = test.isFraud

test_X = test.drop('isFraud', axis=1)
print(train.head(5))
for f in X.columns:

    if X[f].dtype=='object' or test_X[f].dtype=='object': 

        lbl = preprocessing.LabelEncoder()

        lbl.fit(list(X[f].values) + list(test_X[f].values))

        X[f] = lbl.transform(list(X[f].values))

        test_X[f] = lbl.transform(list(test_X[f].values))   
np.unique(y)
# Light Gradient Boosting Machine(LGBM) 
from sklearn.model_selection import train_test_split



train_X, val_X, train_y, val_y = train_test_split(X, y, test_size=0.2, random_state=0)

import lightgbm as lgbm



hyper = {

    'num_leaves' : 500,

    'min_child_weight': 0.03,

    'feature_fraction': 0.4,

    'bagging_fraction': 0.4,

    'min_data_in_leaf': 100,

    'objective': 'binary',

    'max_depth': 6,

    'learning_rate': 0.05,

    'boosting_type': 'gbdt',

    'bagging_seed': 10,

    'metric': 'auc',

    'verbosity': 0,

    'reg_alpha': 0.4,

    'reg_lambda': 0.6,

    'random_state': 0

}



dtrain = lgbm.Dataset(train_X, label=train_y)

dvalid = lgbm.Dataset(val_X, label=val_y)

model = lgbm.train(hyper, dtrain, 10000, valid_sets=[dtrain, dvalid], verbose_eval=200, early_stopping_rounds=500) #–ª—É—á—à–∏–π —Ä–µ–∑–ª—å—Ç–∞—Ç –¥–∞–µ—Ç 10000, –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–¥–∞–¥–∏–º 200

# model = lgbm.train(hyper, dtrain, 200, valid_sets=[dtrain, dvalid], verbose_eval=200, early_stopping_rounds=500) #–ª—É—á—à–∏–π —Ä–µ–∑–ª—å—Ç–∞—Ç –¥–∞–µ—Ç 10000, –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–¥–∞–¥–∏–º 200
preds_lgb = model.predict(test_X)
del train_X, val_X, train_y, val_y

gc.collect()
# LGBM –¥–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –≤—Ä—è–¥ –ª–∏ –∏—Ö —É–ª—É—á—à–∞—Ç + –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ—á–µ–Ω—å –¥–æ–ª–≥–æ



Pr_Other = 0 # 0 - –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã, 1 - –ø—Ä–∏–º–µ–Ω—è—Ç—å
Pr_Test = 0

if Pr_Test:

    del y, X, test_y, test_X 

    gc.collect()

    y = train.isFraud

    X = train.drop('isFraud', axis=1)

    test_y = test.isFraud

    test_X = test.drop('isFraud', axis=1)
if Pr_Other:

    # –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫—É—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –¥–∞–Ω–Ω—ã—Ö

    

    #–¥—Ä–æ–ø–Ω–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∏

    categorical_feats = X.dtypes[ (train.dtypes == "object") | (train.dtypes == "category") ].index

    categorical_feats_kol = len(categorical_feats)

    X.drop(categorical_feats, axis=1, inplace=True)

    test_X.drop(categorical_feats, axis=1, inplace=True)

    

    missing_values_count = X.isnull().sum()

    print (missing_values_count[0:10])

    total_cells = np.product(X.shape)

    total_missing = missing_values_count.sum()

    print ("% –¥–æ fillna –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö = ",(total_missing/total_cells) * 100)

    

    X.fillna(-1,inplace=True)

    test_X.fillna(-1,inplace=True)

    

    missing_values_count = X.isnull().sum()

    print (missing_values_count[0:10])

    total_cells = np.product(X.shape)

    total_missing = missing_values_count.sum()

    print ("% –ø–æ—Å–ª–µ fillna –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö = ",(total_missing/total_cells) * 100)

if Pr_Other:

    # –ù–æ—Ä–º—É–ª–∏–∑—É–µ–º D —Ñ–∏—á–∏

    for i in tqdm_notebook(range(1,16)):

        if i in [1,2,3,5,9]: continue

        X['D'+str(i)] =  X['D'+str(i)] - X.TransactionDT/np.float32(24*60*60)

        test_X['D'+str(i)] = test_X['D'+str(i)] - test_X.TransactionDT/np.float32(24*60*60) 
if 0 & Pr_Other:

    # –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –¥—Ä–æ–ø–Ω–µ–º —á–∞—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

    print(f"–î–æ —É–¥–∞–ª–µ–Ω–∏—è, –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ç–æ–ø —Ñ–∏—á–µ–π —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:\n{X.isna().sum().sort_values(ascending = False).head(5)}\n")

    thresh = 0.80 #–ò–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∑–Ω–∞—á–µ–Ω–∏–π NA (%), —Ç–æ —á—Ç–æ –±–æ–ª—å—à–µ 80% - —ç—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ - —à—É–º

    X_less_nas = X.dropna(thresh=X.shape[0]*(1-thresh), axis='columns')

    cols_dropped  = list(set(X.columns)-set(X_less_nas.columns))

    test_X.drop(cols_dropped, axis=1, inplace=True)

    print(f"–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è, —Ç–æ–ø —Ñ–∏—á–µ–π —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:\n{X_less_nas.isna().sum().sort_values(ascending = False).head(5)}")

    print(f"\n–ö–æ–ª-–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∏—á–µ–π = {len(set(X.columns)-set(X_less_nas.columns))}, or {len(set(X.columns)-set(X_less_nas.columns))/len(X.columns)*100:.2f}% —Ñ–∏—á–µ–π")

    X = X_less_nas

    del X_less_nas

    gc.collect()
if 0 & Pr_Other:

    cols = ['ProductCD', 'card4', 'R_emaildomain', 'M1', 'M2', 'M3', 'M4', 'M5', 'M6', 'M7', 'M8', 'M9', 'id_12', 'id_15', 'id_16', 'id_28', 'id_29', 'id_35', 'id_36', 'id_37', 'id_38', 'DeviceType']

    for col in cols:

        print('-'*25+'['+col+']'+'-'*25)

        print(dataset[[col, 'isFraud']].groupby(col).mean()*100)

    X.drop(cols,axis=1, inplace=True)

    test_X.drop(cols, axis=1, inplace=True)
Pr_SVC = 0

if Pr_SVC & Pr_Other: # –æ—á–µ–Ω—å –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

    from sklearn.model_selection import GridSearchCV

    from sklearn.svm import SVC

    param_grid = {'C': [0.1,10, 100, 1000,5000], 'gamma': [1,0.1,0.01,0.001,0.0001], 'kernel': ['rbf']}

    svc_grid = GridSearchCV(SVC(), param_grid, cv=10, refit=True, verbose=1, scoring='roc_auc')

    svc_grid.fit(X,y)

    sc_svc = get_best_score(svc_grid)

    pred_all_svc = svc_grid.predict(test_X)

Pr_knn = 0 # –æ—á–µ–Ω—å –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–∞–º—è—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è

if Pr_knn & Pr_Other:

    from sklearn.neighbors import KNeighborsClassifier

    knn = KNeighborsClassifier()

    #leaf_range = list(range(3, 15, 1))

    #k_range = list(range(1, 15, 1))

    leaf_range = list(range(3, 4, 1))

    k_range = list(range(1, 2, 1))

    weight_options = ['uniform', 'distance']

    param_grid = dict(leaf_size=leaf_range, n_neighbors=k_range, weights=weight_options)

    print(param_grid)



    knn_grid = GridSearchCV(knn, param_grid, cv=10, verbose=1, scoring='roc_auc')

    knn_grid.fit(X, y)

    sc_knn = get_best_score(knn_grid)

    pred_all_knn = knn_grid.predict(test_X)

    print('KNN: ', roc_auc_score(test_y, pred_all_knn))    
Pr_Tree = 0 # –æ—á–µ–Ω—å –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–∞–º—è—Ç—å –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è

if Pr_Tree & Pr_Other:

    from sklearn.tree import DecisionTreeClassifier

    from sklearn.model_selection import GridSearchCV



    dtree = DecisionTreeClassifier()

    param_grid = {'min_samples_split': [4,7,10,12]}

    dtree_grid = GridSearchCV(dtree, param_grid, cv=10, refit=True, verbose=1)

    dtree_grid.fit(X,y)

    pred_all_dtree = dtree_grid.predict(test_X)

    print('Tree: ', roc_auc_score(test_y, pred_all_dtree))    

    #print(dtree_grid.best_score_)

    #print(dtree_grid.best_params_)

    #print(dtree_grid.best_estimator_)

    
# Submission
submission = sub 

submission['isFraud'] = np.nan

submission.head()
submission['isFraud'] = preds_lgb

submission.head()
submission.to_csv('submission_demin_3.csv', index=False)
sub.loc[ sub['isFraud']>0.99 , 'isFraud'] = 1

b = plt.hist(sub['isFraud'], bins=50)
# del sub

gc.collect()